# Snowhouse SQL Queries for OLTP Solution Advisor

## Find Account ID from Template Information

```sql
SELECT ID as ACCOUNT_ID, DEPLOYMENT, NAME 
FROM SNOWHOUSE.PRODUCT.ALL_LIVE_ACCOUNTS 
WHERE UPPER(NAME) LIKE '%<ACCOUNT_NAME>%' 
  AND DEPLOYMENT LIKE '%<DEPLOYMENT>%'
ORDER BY DS DESC
LIMIT 5;
```

## Query Pattern Analysis (Last 30 Days)

```sql
SELECT 
    st.STATEMENT_TYPE,
    SUM(jf.JOBS) as TOTAL_JOBS,
    ROUND(AVG(jf.DURATION_TOTAL / NULLIF(jf.JOBS, 0)) / 1000, 3) as AVG_DURATION_SEC,
    ROUND(MEDIAN(jf.DURATION_TOTAL / NULLIF(jf.JOBS, 0)) / 1000, 3) as MEDIAN_DURATION_SEC,
    MAX(jf.DURATION_TOTAL) / 1000 as MAX_DURATION_SEC,
    SUM(jf.HIT_CACHE_JOBS) as CACHE_HITS
FROM SNOWHOUSE.PRODUCT.JOB_FACT jf
JOIN SNOWHOUSE.PRODUCT.STATEMENT_TYPE st ON jf.STATEMENT_TYPE_ID = st.ID
WHERE jf.DEPLOYMENT = '<DEPLOYMENT>'
  AND jf.ACCOUNT_ID = <ACCOUNT_ID>
  AND jf.CREATED_HOUR >= DATEADD('day', -30, CURRENT_TIMESTAMP())
  AND st.STATEMENT_TYPE IN ('SELECT', 'INSERT', 'UPDATE', 'DELETE', 'MERGE')
GROUP BY st.STATEMENT_TYPE
ORDER BY TOTAL_JOBS DESC;
```

## Calculate Read:Write Ratio

```sql
SELECT 
    SUM(CASE WHEN st.STATEMENT_TYPE = 'SELECT' THEN jf.JOBS ELSE 0 END) as TOTAL_SELECTS,
    SUM(CASE WHEN st.STATEMENT_TYPE IN ('INSERT', 'UPDATE', 'DELETE', 'MERGE') THEN jf.JOBS ELSE 0 END) as TOTAL_DML,
    ROUND(
        SUM(CASE WHEN st.STATEMENT_TYPE = 'SELECT' THEN jf.JOBS ELSE 0 END) * 1.0 / 
        NULLIF(SUM(CASE WHEN st.STATEMENT_TYPE IN ('INSERT', 'UPDATE', 'DELETE', 'MERGE') THEN jf.JOBS ELSE 0 END), 0)
    , 1) as READ_WRITE_RATIO
FROM SNOWHOUSE.PRODUCT.JOB_FACT jf
JOIN SNOWHOUSE.PRODUCT.STATEMENT_TYPE st ON jf.STATEMENT_TYPE_ID = st.ID
WHERE jf.DEPLOYMENT = '<DEPLOYMENT>'
  AND jf.ACCOUNT_ID = <ACCOUNT_ID>
  AND jf.CREATED_HOUR >= DATEADD('day', -30, CURRENT_TIMESTAMP());
```

## Latency Distribution

```sql
SELECT 
    CASE 
        WHEN jf.DURATION_TOTAL / NULLIF(jf.JOBS, 0) < 10 THEN '1_< 10ms'
        WHEN jf.DURATION_TOTAL / NULLIF(jf.JOBS, 0) < 100 THEN '2_10-100ms'
        WHEN jf.DURATION_TOTAL / NULLIF(jf.JOBS, 0) < 1000 THEN '3_100ms-1s'
        WHEN jf.DURATION_TOTAL / NULLIF(jf.JOBS, 0) < 10000 THEN '4_1-10s'
        ELSE '5_> 10s' 
    END as LATENCY_BUCKET,
    SUM(jf.JOBS) as QUERY_COUNT,
    ROUND(SUM(jf.JOBS) * 100.0 / SUM(SUM(jf.JOBS)) OVER(), 2) as PERCENTAGE
FROM SNOWHOUSE.PRODUCT.JOB_FACT jf
JOIN SNOWHOUSE.PRODUCT.STATEMENT_TYPE st ON jf.STATEMENT_TYPE_ID = st.ID
WHERE jf.DEPLOYMENT = '<DEPLOYMENT>'
  AND jf.ACCOUNT_ID = <ACCOUNT_ID>
  AND jf.CREATED_HOUR >= DATEADD('day', -30, CURRENT_TIMESTAMP())
  AND st.STATEMENT_TYPE = 'SELECT'
GROUP BY LATENCY_BUCKET
ORDER BY LATENCY_BUCKET;
```

## Key Snowhouse Tables

| Table | Purpose |
|-------|---------|
| `SNOWHOUSE.PRODUCT.JOB_FACT` | Query execution metrics (latency, volume) |
| `SNOWHOUSE.PRODUCT.STATEMENT_TYPE` | Statement type classification |
| `SNOWHOUSE.PRODUCT.ALL_LIVE_ACCOUNTS` | Account name to ID mapping |

## Connection Requirement

Requires `Snowhouse` connection with access to SNOWHOUSE.PRODUCT schema.
